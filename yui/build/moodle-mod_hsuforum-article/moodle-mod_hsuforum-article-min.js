YUI.add("moodle-mod_hsuforum-article",function(e,t){function s(){s.superclass.constructor.apply(this,arguments)}function u(){u.superclass.constructor.apply(this,arguments)}function a(){a.superclass.constructor.apply(this,arguments)}var n={DISCUSSION_EDIT:"hsuforum-thread-edit",DISCUSSION_EXPANDED:"hsuforum-thread-article-expanded",POST_EDIT:"hsuforum-post-edit"},r={ADD_DISCUSSION:"#newdiscussionform input[type=submit]",ADD_DISCUSSION_TARGET:".hsuforum-add-discussion-target",ALL_FORMS:".hsuforum-reply-wrapper form",CONTAINER:".mod-hsuforum-posts-container",CONTAINER_LINKS:".mod-hsuforum-posts-container a",DISCUSSION:".hsuforum-thread",DISCUSSIONS:".hsuforum-threads-wrapper",DISCUSSION_EDIT:"."+n.DISCUSSION_EDIT,DISCUSSION_BY_ID:'.hsuforum-thread[data-discussionid="%d"]',DISCUSSION_COUNT:".hsuforum-discussion-count",DISCUSSION_TARGET:".hsuforum-new-discussion-target",DISCUSSION_TEMPLATE:"#hsuforum-discussion-template",DISCUSSION_VIEW:".hsuforum-thread-view",EDITABLE_MESSAGE:"[contenteditable]",EDITABLE_MESSAGE_ATTO:'[id^="editor-target-container"][contenteditable]:not([style*="display: none"])',FORM:".hsuforum-form",FORM_ADVANCED:".hsuforum-use-advanced",FORM_REPLY_WRAPPER:".hsuforum-reply-wrapper",INPUT_FORUM:'input[name="forum"]',INPUT_MESSAGE:'textarea[name="message"]',INPUT_REPLY:'input[name="reply"]',INPUT_SUBJECT:'input[name="subject"]',LINK_CANCEL:".hsuforum-cancel",NO_DISCUSSIONS:".forumnodiscuss",NOTIFICATION:".hsuforum-notification",OPTIONS_TO_PROCESS:".hsuforum-options-menu.unprocessed",PLACEHOLDER:".thread-replies-placeholder",POSTS:".hsuforum-thread-replies",POST_BY_ID:'.hsuforum-post-target[data-postid="%d"]',POST_EDIT:"."+n.POST_EDIT,POST_TARGET:".hsuforum-post-target",RATE:".forum-post-rating",RATE_POPUP:".forum-post-rating a",REPLY_TEMPLATE:"#hsuforum-reply-template",SEARCH_PAGE:"#page-mod-hsuforum-search",VALIDATION_ERRORS:".hsuforum-validation-errors",VIEW_POSTS:".hsuforum-view-posts"},i={DISCUSSION_CREATED:"discussion:created",DISCUSSION_DELETED:"discussion:deleted",FORM_CANCELED:"form:canceled",POST_CREATED:"post:created",POST_DELETED:"post:deleted",POST_UPDATED:"post:updated"};M.mod_hsuforum=M.mod_hsuforum||{},s.NAME="moodle-mod_hsuforum-dom",s.ATTRS={io:{value:null}},e.extend(s,e.Base,{initializer:function(){e.all(r.RATE).addClass("processed"),this.initOptionMenus()},initFeatures:function(){this.initOptionMenus(),this.initRatings()},initRatings:function(){e.all(r.RATE).each(function(t){if(t.hasClass("processed"))return;M.core_rating.Y=e,t.all("select.postratingmenu").each(M.core_rating.attach_rating_events,M.core_rating),t.all("input.postratingmenusubmit").setStyle("display","none"),t.addClass("processed")})},initOptionMenus:function(){e.all(r.OPTIONS_TO_PROCESS).each(function(t){t.removeClass("unprocessed");var n=new e.YUI2.widget.Menu(t.generateID(),{lazyLoad:!0});n.render(e.one(r.CONTAINER).generateID()),e.one("#"+t.getData("controller")).on("click",function(e){e.preventDefault(),n.cfg.setProperty("y",e.currentTarget.getY()+e.currentTarget.get("offsetHeight")),n.cfg.setProperty("x",e.currentTarget.getX()),n.show()})})},handleViewRating:function(e){if(e.currentTarget.ancestor(".helplink")!==null)return;e.preventDefault(),openpopup(e,{url:e.currentTarget.get("href")+"&popup=1",name:"ratings",options:"height=400,width=600,top=0,left=0,menubar=0,location=0,scrollbars,resizable,toolbar,status,directories=0,fullscreen=0,dependent"})},markPostAsRead:function(e,t,n){this.get("io").send({postid:e,action:"markread"},t,n)},incrementDiscussionCount:function(t){var n=e.one(r.DISCUSSION_COUNT);n!==null&&(n.setData("count",parseInt(n.getData("count"),10)+t),n.setHTML(M.util.get_string("xdiscussions","mod_hsuforum",n.getData("count"))))},displayNotification:function(t){var n=e.Node.create(t);e.one(r.NOTIFICATION).append(n),setTimeout(function(){n.remove(!0)},1e4)},handleNotification:function(t){e.Lang.isString(t.notificationhtml)&&t.notificationhtml.trim().length>0&&this.displayNotification(t.notificationhtml)},handleUpdateDiscussion:function(t){var n=e.one("#discussionsview");n?n.setHTML(t.html):(n=e.one(r.DISCUSSION_BY_ID.replace("%d",t.discussionid)),n?(n.replace(t.html),this.initRatings()):e.one(r.DISCUSSION_TARGET).insert(t.html,"after"))},handleDiscussionCreated:function(){e.one(r.NO_DISCUSSIONS)&&e.one(r.NO_DISCUSSIONS).remove()},handleDiscussionDeleted:function(t){var n=e.one(r.POST_BY_ID.replace("%d",t.postid));if(n===null||!n.hasAttribute("data-isdiscussion"))return;e.one(r.DISCUSSIONS)?(n.remove(!0),this.incrementDiscussionCount(-1),e.one(r.DISCUSSION_COUNT).focus()):window.location.href=t.redirecturl}}),M.mod_hsuforum.Dom=s;var o=e.Base.create("hsuforumRouter",e.Router,[],{initializer:function(){},discussion:function(e){this.get("article").viewDiscussion(e.query.d,e.query.postid)},post:function(t){e.Lang.isUndefined(t.query.reply)?e.Lang.isUndefined(t.query.forum)?e.Lang.isUndefined(t.query["delete"])?e.Lang.isUndefined(t.query.edit)?e.Lang.isUndefined(t.query.prune)||(window.location.href=t.url):this.get("article").get("form").showEditForm(t.query.edit):this.get("article").confirmDeletePost(t.query["delete"]):this.get("article").get("form").showAddDiscussionForm(t.query.forum):this.get("article").get("form").showReplyToForm(t.query.reply)},focusHash:function(t){var n=t.get("href").split("#");setTimeout(function(){try{e.one("#"+n[1]).ancestor("li").focus()}catch(t){}},300)},handleRoute:function(e){if(e.button!==1||e.ctrlKey||e.metaKey||e.currentTarget.hasClass("disable-router")||e.currentTarget.hasClass("autolink")||e.currentTarget.ancestor(".posting")){e.currentTarget.get("href").indexOf("#")>-1&&this.focusHash(e.currentTarget);return}this.routeUrl(e.currentTarget.get("href"))&&e.preventDefault()},routeUrl:function(e){return this.hasRoute(e)?(this.save(this.removeRoot(e)),!0):!1},handleAddDiscussionRoute:function(e){e.preventDefault();if(typeof e.currentTarget=="undefined")return;var t=e.currentTarget.ancestor("form"),n=t.one(r.INPUT_FORUM).get("value");this.save(t.get
("action")+"?forum="+n)},handleViewDiscussion:function(t){var n="/discuss.php?d="+t.discussionid;e.Lang.isUndefined(t.postid)||(n=n+"&postid="+t.postid),this.save(n)},hideForms:function(e,t,n){this.get("article").get("form").removeAllForms(),n()}},{ATTRS:{article:{value:null},root:{valueFn:function(){return M.cfg.wwwroot.replace(this._regexUrlOrigin,"")+"/mod/hsuforum"}},routes:{value:[{path:"/view.php",callbacks:["hideForms"]},{path:"/discuss.php",callbacks:["hideForms","discussion"]},{path:"/post.php",callbacks:["hideForms","post"]}]}}});M.mod_hsuforum.Router=o,u.NAME="moodle-mod_hsuforum-form",u.ATTRS={io:{value:null}},e.extend(u,e.Base,{handlePostToGroupsToggle:function(e){var t=e.currentTarget.ancestor("form"),n=t.one("#menugroupinfo");e.currentTarget.get("checked")?n.set("disabled","disabled"):n.set("disabled","")},handleTimeToggle:function(e){e.currentTarget.get("checked")?e.currentTarget.ancestor(".fdate_time_selector").all("select").removeAttribute("disabled"):e.currentTarget.ancestor(".fdate_time_selector").all("select").setAttribute("disabled","disabled")},_displayReplyForm:function(t){var n=e.one(r.REPLY_TEMPLATE).getHTML(),i=t.one(r.FORM_REPLY_WRAPPER);i instanceof e.Node?i.replace(n):t.append(n),i=t.one(r.FORM_REPLY_WRAPPER),this.attachFormWarnings(),i.one(r.INPUT_REPLY).setAttribute("value",t.getData("postid"));var s=i.one(r.FORM_ADVANCED);s.setAttribute("href",s.getAttribute("href").replace(/reply=\d+/,"reply="+t.getData("postid")));var o=i.one("div[id^=editor-target-container-]");s.on("click",function(e){s.setAttribute("href",s.getAttribute("href")+"&msgcontent="+o.get("textContent"))}),t.hasAttribute("data-ispost")&&i.one("legend").setHTML(M.util.get_string("replytox","mod_hsuforum",t.getData("author")))},_copyMessage:function(e){var t=e.one(r.EDITABLE_MESSAGE).get("innerHTML");e.one(".editor_atto")!=null&&(t=e.one(r.EDITABLE_MESSAGE_ATTO).get("innerHTML")),t=t.replace(/&amp;/g,"&"),t=t.replace(/&gt;/g,">"),t=t.replace(/&lt;/g,"<"),t=t.replace(/&quot;/g,'"'),t=t.replace(/&#39;/g,"'"),e.one(r.INPUT_MESSAGE).set("value",t)},_submitReplyForm:function(t,n){t.all("button").setAttribute("disabled","disabled"),this._copyMessage(t);var i=t.all("form input[type=file]"),s=e.one("#hiddenadvancededitordraftid");if(s){var o=s.cloneNode();o.id="hiddenadvancededitordraftidclone",t.one("form input").insert(o,"before")}this.get("io").submitForm(t.one("form"),function(e){e.yuiformsubmit=1,e.errors===!0?(t.one(r.VALIDATION_ERRORS).setHTML(e.html).addClass("notifyproblem"),t.all("button").removeAttribute("disabled")):n.call(this,e)},this,i._nodes.length>0)},attachFormWarnings:function(){e.all(r.ALL_FORMS).each(function(e){if(!e.hasClass("form-checker-added")){var t=M.core_formchangechecker.init({formid:e.generateID()});e.addClass("form-checker-added"),e.one(r.EDITABLE_MESSAGE).on("keypress",M.core_formchangechecker.set_form_changed,t)}})},removeAllForms:function(){e.all(r.POSTS+" "+r.FORM_REPLY_WRAPPER).each(function(e){!e.ancestor(r.DISCUSSION_EDIT)&&!e.ancestor(r.POST_EDIT)&&e.remove(!0)});var t=e.one(r.ADD_DISCUSSION_TARGET);t!==null&&t.empty()},handleCancelForm:function(e){e.preventDefault();var t=e.target.ancestor(r.POST_TARGET);if(!t){t=e.target.ancestor(r.ADD_DISCUSSION_TARGET),e.target.ancestor(r.FORM_REPLY_WRAPPER).remove(!0);if(t)return;return}t.removeClass(n.POST_EDIT).removeClass(n.DISCUSSION_EDIT),e.target.ancestor(r.FORM_REPLY_WRAPPER).remove(!0),this.fire(i.FORM_CANCELED,{discussionid:t.getData("discussionid"),postid:t.getData("postid")})},handleFormSubmit:function(e){e.preventDefault();var t=e.currentTarget.ancestor(r.FORM_REPLY_WRAPPER);this._submitReplyForm(t,function(e){switch(e.eventaction){case"postupdated":this.fire(i.POST_UPDATED,e);break;case"postcreated":this.fire(i.POST_UPDATED,e);break;case"discussioncreated":this.fire(i.DISCUSSION_CREATED,e)}})},sendInProgressData:function(t){var n=e.one("div[id^=editor-target-container-]"),r=e.one("input[name=subject]"),i=t.target.getAttribute("href");i.includes("post.php?edit")||t.target.setAttribute("href",t.target.getAttribute("href")+"&msgcontent="+n.get("textContent")+"&subcontent="+r.get("value"))},showReplyToForm:function(t){var n=e.one(r.POST_BY_ID.replace("%d",t));n.hasAttribute("data-ispost")&&this._displayReplyForm(n),n.one(r.EDITABLE_MESSAGE).focus()},setDateField:function(t,n,r){var i=new Date(r*1e3),s=i.getMinutes(),o=i.getHours(),u=i.getDate(),a=i.getMonth()+1,f=i.getFullYear();n?e.one("#id_time"+t+"_enabled").set("checked",!0):e.one("#id_time"+t+"_enabled").set("checked",!1),s>0&&(s=Math.round(s/5)*5,s==60&&(s=55)),e.one("#id_time"+t+"_minute").set("value",s),e.one("#id_time"+t+"_hour").set("value",o),e.one("#id_time"+t+"_day").set("value",u),e.one("#id_time"+t+"_month").set("value",a),e.one("#id_time"+t+"_year").set("value",f),this.setDateFieldsClassState()},resetDateField:function(t){if(!e.one("#discussion_dateform fieldset"))return;var n=Math.floor(Date.now()/1e3);this.setDateField(t,!1,n)},resetDateFields:function(){var e=["start","end"];for(var t in e)this.resetDateField(e[t])},setDateFieldsClassState:function(){var t=e.one("fieldset.dateform_fieldset");if(!t)return;t.all(".fdate_selector").each(function(e){e.one("input").get("checked")?e.all("select").removeAttribute("disabled"):e.all("select").setAttribute("disabled","disabled")})},applyDateFields:function(){if(e.one(".dateformtarget")){var t=e.one("#discussion_dateform fieldset");if(!t){t=e.Node.create("<fieldset/>"),t.addClass("form-inline");var n=e.all("#discussion_dateform div.row.fitem");if(!(n._nodes.length>0)){var r=e.all("#discussion_dateform .form-inline.felement"),i=e.all(".col-form-label.d-inline"),s=[];i.each(function(e){s.push(e.ancestor())}),r.each(function(n,r){if(r>0){var i=e.Node.create("<div/>");i.addClass("form-group"),t.appendChild(i),i.appendChild(s[r-1]).addClass("row"),i.appendChild(n).addClass("row")}})}n.each(function(e,n){n>0&&t.appendChild(e)})}if(!t)return;t.addClass("dateform_fieldset"),t.removeClass("hidden"),t.one("legend")&&
t.one("legend").remove(),t.all("a.visibleifjs").addClass("disable-router"),e.one(".dateformtarget").append(t)}this.setDateFieldsClassState()},setDateFields:function(e,t){e==0?this.resetDateField("start"):this.setDateField("start",!0,e),t==0?this.resetDateField("end"):this.setDateField("end",!0,t)},setDefaultDateSettings:function(){var t=e.one("#id_timestart_enabled").ancestor(".felement"),n=e.one("#id_timeend_enabled").ancestor(".felement");t.all("select").setAttribute("disabled","disabled"),n.all("select").setAttribute("disabled","disabled")},showAddDiscussionForm:function(){e.one(r.ADD_DISCUSSION_TARGET).setHTML(e.one(r.DISCUSSION_TEMPLATE).getHTML()).one(r.INPUT_SUBJECT).focus(),this.resetDateFields(),this.applyDateFields(),this.attachFormWarnings();try{this.setDefaultDateSettings()}catch(t){}var n=e.one(r.FORM_ADVANCED),i=e.one("div[id^=editor-target-container-]"),s=e.one("input[name=subject]");n.on("click",function(e){n.setAttribute("href",n.getAttribute("href")+"&msgcontent="+i.get("textContent")+"&subcontent="+s.get("value"))})},showEditForm:function(t){var i=e.one(r.POST_BY_ID.replace("%d",t));if(i.hasClass(n.DISCUSSION_EDIT)||i.hasClass(n.POST_EDIT)){i.one(r.EDITABLE_MESSAGE).focus();return}var s=this,o=e.one("#hiddenadvancededitordraftid");this.get("io").send({discussionid:i.getData("discussionid"),postid:i.getData("postid"),draftid:o?o.get("value"):0,action:"edit_post_form"},function(e){i.prepend(e.html),i.hasAttribute("data-isdiscussion")?i.addClass(n.DISCUSSION_EDIT):i.addClass(n.POST_EDIT),i.one(r.EDITABLE_MESSAGE).focus();if(e.isdiscussion){s.applyDateFields();var t=e.offset;if(e.timestart!=0||e.timeend!=0){var o=(new Date).getTimezoneOffset()*60,u=parseInt(e.timestart)+parseInt(o)+parseInt(t),a=parseInt(e.timeend)+parseInt(o)+parseInt(t);s.setDateFields(u,a)}else s.setDateFields(e.timestart,e.timeend)}this.attachFormWarnings()},this)}}),M.mod_hsuforum.Form=u,a.NAME=t,a.ATTRS={contextId:{value:undefined},io:{readOnly:!0},dom:{readOnly:!0},router:{readOnly:!0},form:{readOnly:!0},liveLog:{readOnly:!0},currentEditLink:null},e.extend(a,e.Base,{initializer:function(){this._set("router",new M.mod_hsuforum.Router({article:this,html5:!1})),this._set("io",new M.mod_hsuforum.Io({contextId:this.get("contextId")})),this._set("dom",new M.mod_hsuforum.Dom({io:this.get("io")})),this._set("form",new M.mod_hsuforum.Form({io:this.get("io")})),this._set("liveLog",M.mod_hsuforum.init_livelog()),this.bind()},bind:function(){var t=document.getElementsByClassName("hsuforum-post-unread")[0];if(t&&location.hash==="#unread"){var n=document.getElementById(t.id).parentNode;if(navigator.userAgent.match(/Trident|MSIE/)){var s,o;s=n.offsetTop,o=n;while(o=o.offsetParent)s+=o.offsetTop;window.scrollTo(0,s)}else n.scrollIntoView();n.focus()}if(e.one(r.SEARCH_PAGE)!==null)return;var u=this.get("dom"),a=this.get("form"),f=this.get("router"),l='.hsuforum-discussion input[name="posttomygroups"]';e.delegate("click",a.handlePostToGroupsToggle,document,l,a),e.delegate("click",a.handleTimeToggle,document,"#id_timestart_enabled",a),e.delegate("click",a.handleTimeToggle,document,"#id_timeend_enabled",a),e.delegate("click",a.handleCancelForm,document,r.LINK_CANCEL,a),e.delegate("click",f.handleRoute,document,r.CONTAINER_LINKS,f),e.delegate("click",u.handleViewRating,document,r.RATE_POPUP,u),e.delegate("submit",a.handleFormSubmit,document,r.FORM,a),e.delegate("click",f.handleAddDiscussionRoute,document,r.ADD_DISCUSSION,f),e.delegate("click",a.sendInProgressData,document,r.FORM_ADVANCED,a),a.on(i.POST_CREATED,u.handleUpdateDiscussion,u),a.on(i.POST_CREATED,u.handleNotification,u),a.on(i.POST_CREATED,f.handleViewDiscussion,f),a.on(i.POST_CREATED,this.handleLiveLog,this),a.on(i.POST_UPDATED,this.handlePostUpdated,this),a.on(i.DISCUSSION_CREATED,u.handleUpdateDiscussion,u),a.on(i.DISCUSSION_CREATED,u.handleDiscussionCreated,u),a.on(i.DISCUSSION_CREATED,u.handleNotification,u),a.on(i.DISCUSSION_CREATED,f.handleViewDiscussion,f),a.on(i.DISCUSSION_CREATED,this.handleLiveLog,this),this.on(i.DISCUSSION_DELETED,u.handleDiscussionDeleted,u),this.on(i.DISCUSSION_DELETED,u.handleNotification,u),this.on(i.DISCUSSION_DELETED,this.handleLiveLog,this),this.on(i.POST_DELETED,u.handleUpdateDiscussion,u),this.on(i.POST_DELETED,f.handleViewDiscussion,f),this.on(i.POST_DELETED,u.handleNotification,u),this.on(i.POST_DELETED,this.handleLiveLog,this),a.on(i.FORM_CANCELED,f.handleViewDiscussion,f)},handlePostUpdated:function(e){var t=this.get("dom"),n=this.get("form"),r=this.get("router");t.handleUpdateDiscussion(e),r.handleViewDiscussion(e),t.handleNotification(e),this.handleLiveLog(e)},handleLiveLog:function(t){e.Lang.isString(t.livelog)&&this.get("liveLog").logText(t.livelog)},viewDiscussion:function(t,n){var i=e.one(r.DISCUSSION_BY_ID.replace("%d",t));if(!(i instanceof e.Node))return;if(!e.Lang.isUndefined(n)){var s=e.one(r.POST_BY_ID.replace("%d",n));s===null||s.hasAttribute("data-isdiscussion")?i.focus():s.get("parentNode").focus()}else i.focus()},confirmDeletePost:function(t){var n=e.one(r.POST_BY_ID.replace("%d",t));if(n===null)return;window.confirm(M.str.mod_hsuforum.deletesure)===!0&&this.deletePost(t)},deletePost:function(t){var n=e.one(r.POST_BY_ID.replace("%d",t));if(n===null)return;this.get("io").send({postid:t,sesskey:M.cfg.sesskey,action:"delete_post"},function(e){n.hasAttribute("data-isdiscussion")?this.fire(i.DISCUSSION_DELETED,e):this.fire(i.POST_DELETED,e)},this)}}),M.mod_hsuforum.Article=a,M.mod_hsuforum.init_article=function(e){new a(e)},M.mod_hsuforum.dispatchClick=function(e){if(document.createEvent){var t=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!0});e.dispatchEvent(t)}else e.fireEvent&&e.fireEvent("onclick")}},"@VERSION@",{requires:["base","node","event","router","core_rating","querystring","moodle-mod_hsuforum-io","moodle-mod_hsuforum-livelog","moodle-core-formchangechecker"]});
